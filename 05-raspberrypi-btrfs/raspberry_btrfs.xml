<?xml version="1.0"?>
<ns0:RootFileSystem xmlns:ns0="https://www.linutronix.de/projects/Elbe" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" created="2009-05-20T08:50:56" revision="6" xsi:schemaLocation="https://www.linutronix.de/projects/Elbe dbsfed.xsd">
  <project>
    <name>RaspberryPi-Btrfs</name>
    <version>1.0</version>
    <description>Rapsberry Pi Btrfs image</description>
    <buildtype>aarch64</buildtype>
    <mirror>
      <primary_host>ftp.de.debian.org</primary_host>
      <primary_path>/debian</primary_path>
      <primary_proto>http</primary_proto>
      <url-list>
        <url>
          <binary>http://deb.debian.org/debian-security bookworm-security main</binary>
          <source>http://deb.debian.org/debian-security bookworm-security main</source>
        </url>
        <url>
          <binary>http://deb.debian.org/debian bookworm non-free-firmware</binary>
          <source>http://deb.debian.org/debian bookworm non-free-firmware</source>
        </url>
        <url>
          <binary>http://deb.debian.org/debian-security bookworm-security non-free-firmware</binary>
          <source>http://deb.debian.org/debian-security bookworm-security non-free-firmware</source>
        </url>
      </url-list>
    </mirror>
    <suite>bookworm</suite>
  </project>
  <target>
    <hostname>rpi64</hostname>
    <domain/>
    <passwd_hashed>$6$bOQ4Sf4rSdI1IfRd$3Hai04jz2OYEW108SZWeweGO/rGvO65ITthDDtDuaC/8Gpwek/xT4rUvKBkBHFIjTDd6.klFdNJ685kxgabHh/</passwd_hashed>
    <console>serial0,115200</console>
    <package>
      <tar>
        <name>rootfs.tgz</name>
      </tar>
    </package>
    <debootstrap>
      <variant>minbase</variant>
    </debootstrap>
    <images>
      <msdoshd>
        <name>sdcard.img</name>
        <size>8GB</size>
        <partition>
          <size>128MB</size>
          <label>firmware</label>
        </partition>
        <partition>
          <size>remain</size>
          <label>root</label>
          <bootable/>
        </partition>
      </msdoshd>
    </images>
    <fstab>
      <bylabel>
        <label>firmware</label>
        <mountpoint>/boot/firmware</mountpoint>
        <fs>
          <type>vfat</type>
        </fs>
      </bylabel>
      <bylabel>
        <label>root</label>
        <mountpoint>/</mountpoint>
        <fs>
          <type>btrfs</type>
          <fs-finetuning>
            <path-command>mkdir -p {path}/volumes/ </path-command>
            <path-command>btrfs subvolume create {path}/volumes/@rootfs</path-command>
          </fs-finetuning>
        </fs>
      </bylabel>
    </fstab>
    <project-finetuning>
      <set_packer packer="none">sdcard.img</set_packer>
      <losetup img="sdcard.img">
      <command part="2" nomount="true">
        mount   ${ELBE_DEV} /mnt
      </command>
      <command part="2" nomount="true">
        tar -xvf ../rootfs.tgz -C /mnt/volumes/@rootfs
      </command>
      <command part="2" nomount="true">
        cd /mnt ; rm -rfv bin,boot,dev,etc,home,initrd.img,initrd.img.old,lib,lost+found,media,mnt,networkd,opt,proc,root,run,sbin,srv,sys,tmp,usr,var,vmlinuz,vmlinuz.old
      </command>
      <command part="2" nomount="true">
        cd / ; umount /mnt
      </command>
      </losetup>
    </project-finetuning>
    <install-recommends/>
    <pkg-list>
      <pkg>linux-image-arm64</pkg>
      <pkg>firmware-brcm80211</pkg>
      <pkg>raspi-firmware</pkg>
      <pkg>zstd</pkg>
      <pkg>apt-utils</pkg>
      <pkg>systemd</pkg>
      <pkg>vim-tiny</pkg>
      <pkg>busybox</pkg>
      <pkg>bash</pkg>
      <pkg>openssh-server</pkg>
      <pkg>openssh-server</pkg>
      <pkg>wpasupplicant</pkg>
      <pkg>iproute2</pkg>
      <pkg>net-tools</pkg>
      <pkg>iputils-ping</pkg>
      <pkg>iw</pkg>
      <pkg>ifupdown</pkg>
      <pkg>bluez</pkg>
      <pkg>bluez-tools</pkg>
      <pkg>rfkill</pkg>
      <pkg>avahi-daemon</pkg>
      <pkg>avahi-utils</pkg>
      <pkg>btrfs-progs</pkg>
      <pkg>btrbk</pkg>
      <pkg>rsync</pkg>
    </pkg-list>
    <finetuning>
      <file dst="/etc/systemd/network/25-wlan0.network" mode="644">
        [Match]
        Name=wlan0

   [Network]
   DHCP=yes
 </file>
 <file dst="/etc/wpa_supplicant/wpa_supplicant-wlan0.conf" mode="600">
 ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
 update_config=1
 country=US

 network={
 ssid=" SomeSSID "
 psk=" SomeKey "
 }
 </file>
 <file dst="/etc/default/raspi-firmware" append="true">
   ROOTPART="LABEL=root"
   KERNEL_ARCH="arm64"
 </file>
 <file dst="/etc/default/raspi-extra-cmdline" append="true">
   rootflags=subvol=volumes/@rootfs init=/usr/lib/systemd/systemd
 </file>
 <file dst="/etc/btrbk/btrbk.conf">
   transaction_log /var/log/btrbk.log
   timestamp_format short
   snapshot_dir snaps
   snapshot_create always

   volume /
     subvolume /
     snapshot_preserve_min 7d
     snapshot_preserve 7d
 </file>
 <file dst="/etc/fstab" append="true">
   /dev/mmcblk0p2  /btrfs  btrfs  defaults,subvolid=5  0  0
 </file>
 <command>update-initramfs -u -k all</command>
 <command>systemctl enable wpa_supplicant@wlan0.service</command>
 <command>systemctl enable systemd-networkd</command>
 <command>systemctl enable avahi-daemon</command>
 <command>update-initramfs -u -k all</command>
 <command>mkdir /volumes</command>
 <command>mkdir /snaps</command>
 <command>mkdir /btrfs</command>
</finetuning>
</target>
</ns0:RootFileSystem>
